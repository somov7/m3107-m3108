#include <stdio.h>
#include <string.h>
#include <ctype.h> 
#include <locale.h>
#include <string.h>
#include <time.h>
#include <limits.h>
#include <stdbool.h>
#include <stdlib.h>

long long max_right;
long long max_left;
int queue_size = 0;
typedef struct queue {
    long long value;
    struct queue *next;
} queue_c;

queue_c *head = NULL;
queue_c *tail = NULL;

queue_c *push(long long x) {
    queue_c *ptr = (queue_c*) malloc(sizeof(queue_c));
    if (head != NULL) {
        tail->next = ptr;
        ptr->value = x;
        ptr->next = NULL;
        tail = ptr;
    }
    else {
        ptr->value = x;
        ptr->next = NULL;
        tail = ptr;
        head = ptr;
    }
    queue_size++;
}

void pop() {
    if (head != NULL) {
        queue_c *temp = head->next;
        free(head);
        head = temp;
    }
    queue_size--;
}

int main(int argc, char **argv) {
    setlocale(LC_ALL, "Rus");
    if (argc != 3) {
        fprintf(stderr, "Ошибка!\nНеверное количество параметров\n");
        return 1;
    }
    FILE *fin;
    fin = fopen(argv[1], "r");
    if (fin == NULL) {
        fprintf(stderr, "Ошибка!\nФайл не найден\n");
        return 1;
    }
    long long sec = atoi(argv[2]);
    char request[400];
    char currentchar;
    int request_length;
    int count_errors_5xx = 0;
    int count_errors = 0;
    long long max_requests = 0;
    long long temp_time1 = 0;
    long long temp_time2 = 0;
    long long current_requests = 0;
    struct tm *time;
    char month[3];
    char months[12][4] = {"Jan", "Feb", "Mar","Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"};
    currentchar = getc(fin);
    printf("Список неудачных запросов: \n");
    while (currentchar != EOF) {
        currentchar = getc(fin);
        while ((currentchar != EOF) && (currentchar != '[')) {
            currentchar = getc(fin);
        }
        if (currentchar == EOF) 
            break;
        time -> tm_mday = (getc(fin)-48) * 10 + getc(fin) - 48;
        currentchar = getc(fin);
        month[0] = getc(fin);
        month[1] = getc(fin);
        month[2] = getc(fin);
        int temp = 0;
        int checker = 1;
        while (checker == 1) {
            if ((months[temp][0] == month[0]) && (months[temp][1] == month[1]) && (months[temp][2] == month[2])) {
                        time -> tm_mon = temp;
                        checker = 0;      
            }
            else 
                temp++;
        }
        currentchar = getc(fin);
        time -> tm_year = (getc(fin) - 48) * 1000 + (getc(fin) - 48) * 100 + (getc(fin) - 48) * 10 + (getc(fin) - 48) - 1900;
        currentchar = getc(fin);
        time -> tm_hour = (getc(fin) - 48) * 10 + (getc(fin) - 48);
        currentchar = getc(fin);
        time -> tm_min = (getc(fin) - 48) * 10 + (getc(fin) - 48);
        currentchar = getc(fin);
        time -> tm_sec = (getc(fin) - 48) * 10 + (getc(fin) - 48);
        temp_time1 = mktime(time);
        if (max_requests == 0) {
            push(temp_time1); 
            current_requests++; 
            temp_time2 = temp_time1;
        }
        else {
            if(temp_time1-temp_time2<=sec) {
                push(temp_time1); 
                current_requests++; 
            }
            else {
                while ((temp_time1-temp_time2>sec) && (queue_size!=0)) {
                    pop();
                    if (queue_size != 0) { 
                        temp_time2 = head -> value;
                    }
                    current_requests--;
                }
                push(temp_time1); 
                current_requests++; 
                if (queue_size==1) {
                    temp_time2 = temp_time1;
                }
            }
        }
        while ((currentchar != '"') && (currentchar != EOF)) {
            currentchar = getc(fin);
        }
        if (currentchar == EOF) 
            break;
        request_length = 0;
        currentchar = getc(fin);
        while ((currentchar != '"') && (currentchar != EOF)) {
            request[request_length] = currentchar;
            request_length++;
            currentchar = getc(fin);
        }
        if (currentchar == EOF) 
            break;
        for (int j = 0; j<2; j++) {
            currentchar = getc(fin);
        }
        if ((currentchar != '1') && (currentchar != '2') && ((currentchar == '5') || (currentchar == '4'))) {
                count_errors++;
            if (currentchar == '5') {
                count_errors_5xx++;
                for (int i = 0; i<=request_length-1; i++) {
                    printf("%c", request[i]);
                    if (i == request_length-1) {
                        printf("\n");
                    }
                }
            }
        }
        while ((currentchar != '\n') && (currentchar != EOF)) {
            currentchar = getc(fin);
        }
        if (current_requests > max_requests) {
            max_requests = current_requests;
            max_left = temp_time2;
            max_right = temp_time1;
        }
    }
    printf("%i запросов с ошибкой \n", count_errors);
    printf("%i запросов с ошибкой 5xx \n", count_errors_5xx);
    printf("максимальное количество запросов за % lli секунд:", sec);
    printf("% lli \n", max_requests);
    time = localtime(&max_left);
    printf("c:\n %s", asctime(time));
    time = localtime(&max_right);
    printf("по:\n %s", asctime(time));
    return 0;
}
